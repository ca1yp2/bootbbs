package net.ca1yps.bootbbs.service;

import java.io.File;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.List;
import java.util.Optional;

import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import jakarta.transaction.Transactional;
import net.ca1yps.bootbbs.entity.FileEntity;
import net.ca1yps.bootbbs.repository.FileRepository;

@Service
public class FileService {
    private final FileRepository fileRepository;
    private final String uploadPath = "/upload/";

    public FileService(FileRepository fileRepository){
        this.fileRepository = fileRepository;
    }

    //íŒŒì¼ ì €ì¥
    public FileEntity save(FileEntity file){
        return fileRepository.save(file);
    }

    //íŒŒì¼ ì•„ì´ë””ë¡œ ê°€ì ¸ì˜¤ê¸°
    public Optional<FileEntity> getFileById(Long id){
        return fileRepository.findById(id);
    }

    //íŠ¹ì • ê²Œì‹œë¬¼ì— ì†Œì†ëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
    public List<FileEntity> getFilesByBid(Long bid){
        return fileRepository.findByBid(bid);
    }

    //timestamp ë“±ë¡ëœ bid ì°¾ì•„ì„œ idë¡œ ë³€ê²½
    @Transactional
    public void updateBidByTempkey(Long tempBid, Long realBid){
        List<FileEntity> files = fileRepository.findByBid(tempBid);
        for(FileEntity file: files){
            file.setBid(realBid);
            fileRepository.save(file);
        }
    }

    @Transactional
    public boolean deleteFile(String nFilename){
        Optional<FileEntity> fileOpt = fileRepository.findByNewFilename(nFilename);
        if(fileOpt.isPresent()){
            FileEntity file = fileOpt.get();
            
            //ì‹¤ì œ íŒŒì¼ ì‚­ì œ
            File realFile = new File(uploadPath + file.getNewFilename());
            if(realFile.exists()){
                realFile.delete();
            } 
            //DB ì‚­ì œ
            fileRepository.deleteById(file.getId());
            return true;
        }
        return false;
    }

    //ê²Œì‹œê¸€ ì‚­ì œ ë  ë•Œ ì†Œì†ëœ íŒŒì¼ë„ ì‚­ì œ
    @Transactional
    public void deleteFilesByBid(Long bid){
        List<FileEntity> files = fileRepository.findByBid(bid);
        for(FileEntity file: files){
            deleteFile(file.getNewFilename());
        }
    }

    //ì¼ì • ì‹œê°„ì´ ë˜ë©´ íŒŒì¼ì„ ì‚­ì œí•´ ì£¼ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬
    @Scheduled(cron = "0 15 14 * * * ")
    public void scheduledFileCleanup(){
        int deletedCount = cleanUpUnlinkedOldFiles();
        System.out.println("ğŸ§¹" + deletedCount + "ê°œì˜ íŒŒì¼ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.");
    }

    public int cleanUpUnlinkedOldFiles(){
        long minTimestamp = 10000000000000L;

        //ì˜¤ëŠ˜ 0ì‹œ ê°€ì ¸ì˜¤ê¸°
        LocalDate today = LocalDate.now();
        LocalDateTime midnight = today.atStartOfDay();
        long todayZero = midnight.atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();
        List<FileEntity> trashFiles = fileRepository.findByTrashFile(minTimestamp, todayZero);
        int count = 0;
        for(FileEntity tfile : trashFiles){
            if(deleteFile(tfile.getNewFilename())){
                count++;
            }
        }
        return count;
    }
}
